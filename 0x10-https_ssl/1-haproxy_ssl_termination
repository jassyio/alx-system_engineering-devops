#!/usr/bin/env bash
# ssl_termination_setup.sh

domain="www.holberton.online" # Replace with your domain
email="your_email@example.com" # Replace with your email

# Install certbot if not installed
if ! command -v certbot &>/dev/null; then
    sudo apt-get update
    sudo apt-get install -y certbot
fi

# Create SSL certificate using certbot
sudo certbot certonly --standalone -d "$domain" --agree-tos -m "$email"

# Update HAProxy configuration for SSL termination
sudo tee /etc/haproxy/haproxy.cfg > /dev/null <<EOF
frontend www-http
    bind *:80
    mode http
    redirect scheme https code 301 if !{ ssl_fc }

frontend www-https
    bind *:443 ssl crt /etc/letsencrypt/live/www.holberton.online/fullchain.pem
    mode http
    option httplog
    acl is_holberton hdr_dom(host) -i www.holberton.online
    use_backend holberton_backend if is_holberton

backend holberton_backend
    mode http
    balance roundrobin
    server web1 web-01-ip:80 check
    server web2 web-02-ip:80 check
EOF

# Restart HAProxy service to apply changes
sudo systemctl restart haproxy
